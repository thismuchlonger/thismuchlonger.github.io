<!DOCTYPE html>
  <head>
    <link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheets/application.css">
    <script type="text/javascript" src="/javascripts/jquery.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.cookie.js"></script>
    <script type="text/javascript" src="/javascripts/bootstrap.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
        $.cookie.json = true;

        function Grid(canvas, count, size, padding) {
          this.canvas = canvas;
          this.days = count;
          this.size = size;
          this.padding = padding;
          this.canvasContext = canvas[0].getContext("2d");

          this.width = function() {
            return canvas.width();
          };

          this.minWidth = function() {
            return this.daysPerRow() * (this.size + this.padding);
          }

          this.height = function() {
            return Math.ceil(this.days / this.daysPerRow()) * (this.size + this.padding);
          };

          this.container = function() {
            return $(canvas.parent());
          };

          this.daysPerRow = function() {
            return Math.floor(this.width() / (this.padding + this.size));
          };

          this.row = function(day) {
            return Math.floor(day / this.daysPerRow());
          };

          this.rowValue = function(day) {
            return this.row(day) * (this.size + this.padding);
          };

          this.colValue = function(day) {
            return (day * (this.size + this.padding)) - (this.row(day) * this.daysPerRow() * (this.padding + this.size));
          };

          this.excess = function() {
            return this.width() % (this.size + this.padding);
          };

          this.coords = function(day) {
            var array = [];

            for (var day=0; day<this.days; day++){
              array.push([this.colValue(day),this.rowValue(day)]);
            }

            return array;
          };

          this.draw = function() {
            this.canvas.attr('height', this.height());
            this.canvas.attr('width', this.minWidth());

            var coords = this.coords();

            for (var day = 0; day < this.days; day++){
              this.canvasContext.imageSmoothingEnabled = false;
              this.canvasContext.fillStyle = "#ccc";
              this.canvasContext.fillRect(coords[day][0], coords[day][1], this.size, this.size);
            };
          };
        };

        function respondCanvas(grid) {
          grid.canvas.attr('width', grid.container().width());
          grid.draw();
        }

        $("form").submit(function(e){
          e.preventDefault();

          var age = parseInt($("#age").val(), 10);
          var expectancy = parseInt($("#expectancy").val(), 10);

          $.cookie('this_much_longer', {"age": age, "expectancy": expectancy});

          updateValues();

          $("#config-modal").modal('hide')
        });

        function updateValues() {
          var age = $.cookie('this_much_longer')['age'];
          var expectancy = $.cookie('this_much_longer')['expectancy'];
          var yearsRemaining = expectancy - age;
          var monthsRemaining = 12 * yearsRemaining;
          var daysRemaining = yearsRemaining * 52 * 7;

          $("meter").attr("max", expectancy);
          $("meter").val(age);
          $("#meterPercent .current").html(Math.round((age/expectancy)*100));

          $(".remaining .years").html(yearsRemaining);
          $(".remaining .months").html(monthsRemaining);
          $(".remaining .days").html(daysRemaining);

          var daysGrid = new Grid($("#days"), daysRemaining, 7, 2);
          respondCanvas(daysGrid);

          var monthsGrid = new Grid($("#months"), monthsRemaining, 38, 4);
          respondCanvas(monthsGrid);

          var yearsGrid = new Grid($("#years"), yearsRemaining, 133, 8);
          respondCanvas(yearsGrid);

          $("#age").val($.cookie('this_much_longer')['age']);
          $("#expectancy").val($.cookie('this_much_longer')['expectancy']);
        };

        $("button").on("click", function(){
          $("form").submit();
        });

        updateValues();
      });
    </script>
  </head>
  <body>
    <header>
        <nav class="navbar navbar-static-top" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <a class="navbar-brand" href="/">not much longer</a>
            </div>
            <ul class="nav navbar-nav navbar-right">
              <li>
                <a data-toggle="modal" data-target="#config-modal">
                  <span class="glyphicon glyphicon-cog"></span> Config
                </a>
              </li>
            </ul>
          </div>
        </nav>
    </header>

    <main>
      <section class="container">
        <div id="meterContainer">
          <span id="meterPercent">
            <span class="current"></span>%
          </span>

          <meter max="100" value="0"></meter>
        </div>
      </section>

      <section class="container">
        <span class="remaining">
          <span class="days"></span>
          <span class="units">Days</span>
        </span>
        <div class="canvasContainer">
          <canvas id="days" width="1000" height="500"></canvas>
        </div>
      </section>

      <section class="container">
        <span class="remaining">
          <span class="months"></span>
          <span class="units">Months</span>
        </span>
        <div class="canvasContainer">
          <canvas id="months" width="1000" height="500"></canvas>
        </div>
      </section>

      <section class="container">
        <span class="remaining">
          <span class="years"></span>
          <span class="units">Years</span>
        </span>
        <div class="canvasContainer">
          <canvas id="years" width="1000" height="500"></canvas>
        </div>
      </section>
    </main>

    <div class="modal fade" id="config-modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Config</h4>
          </div>
          <form>
            <div class="modal-body">
              <div class="form-group">
                <label for="age">How old are you?</label>
                <input type="number" class="form-control" id="age" placeholder="e.g. 25">
              </div>

              <div class="form-group">
                <label for="expectancy">How long do you want to live?</label>
                <input type="number" class="form-control" id="expectancy" placeholder="e.g. 65">
              </div>
            </div>
            <div class="modal-footer">
              <input type="submit" class="btn btn-primary" value="Update">
            </div>
          </form>
        </div>
      </div>
    </div>

    <footer>
    </footer>
  </body>
</html>
